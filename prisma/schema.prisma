// Schema for Social Media Post Scheduler
// Supports multiple social media platforms and organizations
// Handles user management, social accounts, post scheduling, and media attachments

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Represents application users who can be members of multiple organizations
model User {
  id            String    @id @default(uuid())
  name          String    @db.VarChar(255)
  email         String    @unique @db.VarChar(255)
  password      String // Hashed password
  emailVerified DateTime? // Timestamp of email verification
  image         String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  memberships Member[] // User's memberships across organizations
  sessions    Session[] // Active sessions for the user

  @@index([email])
  @@map("users")
}

// Represents an organization that can have multiple team members and social accounts
model Organisation {
  id        String   @id @default(uuid())
  name      String   @db.VarChar(255)
  slug      String   @unique @db.VarChar(100) // URL-friendly identifier
  image     String?  @db.Text
  isActive  Boolean  @default(true) // Soft deletion status
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members  Member[] // Team members of the organization
  sessions Session[] // Active sessions within the organization
  socials  SocialAccount[] // Connected social media accounts
  posts    Post[] // All posts created by the organization
  invites  Invite[] // Pending invitations to join the organization
  medias   MediaAttachment[]

  @@index([slug])
  @@map("organisations")
}

// Represents a user's membership within an organization
model Member {
  id        String       @id @default(uuid())
  role      Role         @default(MEMBER) // User's role in the organization
  status    InviteStatus @default(PENDING) // Membership status
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // Relations
  user           User?        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String? // Nullable for pending invites
  organisation   Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  organisationId String

  scheduledPosts  Post[] // Posts created by this member
  sessions        Session[] // Active sessions of this member
  mediaAttachment MediaAttachment[]

  @@unique([userId, organisationId]) // User can only have one membership per organization
  @@index([organisationId])
  @@index([userId])
  @@map("members")
}

// Tracks invitations sent to users to join an organization
model Invite {
  id        String       @id @default(uuid())
  email     String       @db.VarChar(255) // Recipient's email
  role      Role         @default(MEMBER) // Offered role in the organization
  status    InviteStatus @default(PENDING)
  createdAt DateTime     @default(now())

  // Relations
  organisation   Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  organisationId String
  invitedBy      String // UUID of the user who created the invite

  @@index([email])
  @@index([organisationId])
  @@map("invites")
}

// Tracks active user sessions across organizations
model Session {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now())
  lastActive DateTime @default(now()) // Last activity timestamp for session management

  // Relations
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  member         Member       @relation(fields: [memberId], references: [id], onDelete: Cascade)
  memberId       String
  organisation   Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  organisationId String

  @@index([userId])
  @@index([lastActive])
  @@map("sessions")
}

// Represents a connected social media account
model SocialAccount {
  id         String      @id @default(uuid())
  type       AccountType // Type of social media platform
  identifier String // Platform-specific unique identifier
  name       String      @db.VarChar(255)
  email      String?     @db.VarChar(255)
  profileUrl String?     @db.Text
  metadata   Json        @default("{}") // Platform-specific account data

  // Authentication
  accessToken  String // OAuth access token
  refreshToken String? // OAuth refresh token
  expiresAt    DateTime? // Token expiration timestamp
  isActive     Boolean   @default(true)
  lastSyncAt   DateTime? // Last successful sync with the platform

  // Relations
  organisation   Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  organisationId String
  posts          Post[] // Posts scheduled for this account

  @@unique([type, identifier, organisationId]) // Each account can only be connected once per org
  @@index([type])
  @@index([organisationId])
  @@index([isActive])
  @@map("social_accounts")
}

// Represents a social media post that can be scheduled
model Post {
  id           String      @id @default(uuid())
  type         AccountType // Platform type for the post
  content      String      @db.Text // Post content
  scheduledFor DateTime // Scheduled publication time
  status       PostStatus  @default(DRAFT)
  publishedAt  DateTime? // Actual publication timestamp
  errorMessage String?     @db.Text // Error message if publication failed
  metadata     Json        @default("{}") // Platform-specific post data

  // Relations
  socialAccount   SocialAccount @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)
  socialAccountId String

  createdBy   Member @relation(fields: [createdById], references: [id], onDelete: Restrict)
  createdById String

  organisation   Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  organisationId String

  media PostMedia[] // Attached media files

  @@index([status])
  @@index([scheduledFor])
  @@index([socialAccountId])
  @@index([createdById])
  @@index([organisationId])
  @@map("posts")
}

// Junction table for post-media relationship
model PostMedia {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  // Relations
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId String

  media   MediaAttachment @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  mediaId String

  @@unique([postId, mediaId])
  @@index([postId])
  @@index([mediaId])
  @@map("post_media")
}

// Represents media files attached to posts (images, videos, etc.)
model MediaAttachment {
  id        String    @id @default(uuid())
  type      MediaType // Type of media file
  url       String    @db.Text // Public S3 URL
  key       String    @db.Text // S3 object key
  filename  String    @db.VarChar(255)
  size      Int // File size in bytes
  mimeType  String    @db.VarChar(127)
  width     Int? // Image/video width
  height    Int? // Image/video height
  duration  Float? // Video/audio duration in seconds
  metadata  Json      @default("{}") // Platform-specific media metadata
  createdAt DateTime  @default(now())

  organisation   Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  organisationId String

  createdBy   Member @relation(fields: [createdById], references: [id], onDelete: Restrict)
  createdById String

  posts PostMedia[] // Attached to post

  @@index([organisationId])
  @@index([createdById])
  @@index([type])
  @@map("media_attachments")
}

// Currently supported social media platforms
enum AccountType {
  LINKEDIN
  // Future platforms can be added here
}

// Post publication status
enum PostStatus {
  DRAFT // Initial state
  SCHEDULED // Queued for publication
  PUBLISHED // Successfully published
  FAILED // Publication failed
}

// Supported media types
enum MediaType {
  IMAGE // Static images
  VIDEO // Video files
  DOCUMENT // Documents (PDFs, etc.)
  GIF // Animated GIFs
  AUDIO // Audio files
}

// Invitation status
enum InviteStatus {
  PENDING // Awaiting acceptance
  ACCEPTED // Invitation accepted
}

// Organization member roles
enum Role {
  OWNER // Full control
  ADMIN // Management access
  MEMBER // Basic access
}
